{"version":3,"sources":["../../../../../../qreact-app/node_modules/websocket-extensions/lib/pipeline/index.js"],"names":["Cell","require","Pledge","Pipeline","sessions","_cells","map","session","_stopped","incoming","outgoing","prototype","processIncomingMessage","message","callback","context","_loop","length","processOutgoingMessage","close","closed","a","all","then","call","direction","start","end","step","cells","n","self","pending","pipe","index","error","msg","err","m","module","exports"],"mappings":"AAAA;;AAEA,IAAIA,OAASC,QAAQ,QAAR,CAAb;AAAA,IACIC,SAASD,QAAQ,UAAR,CADb;;AAGA,IAAIE,WAAW,SAAXA,QAAW,CAASC,QAAT,EAAmB;AAChC,OAAKC,MAAL,GAAgBD,SAASE,GAAT,CAAa,UAASC,OAAT,EAAkB;AAAE,WAAO,IAAIP,IAAJ,CAASO,OAAT,CAAP;AAA0B,GAA3D,CAAhB;AACA,OAAKC,QAAL,GAAgB,EAACC,UAAU,KAAX,EAAkBC,UAAU,KAA5B,EAAhB;AACD,CAHD;;AAKAP,SAASQ,SAAT,CAAmBC,sBAAnB,GAA4C,UAASC,OAAT,EAAkBC,QAAlB,EAA4BC,OAA5B,EAAqC;AAC/E,MAAI,KAAKP,QAAL,CAAcC,QAAlB,EAA4B;AAC5B,OAAKO,KAAL,CAAW,UAAX,EAAuB,KAAKX,MAAL,CAAYY,MAAZ,GAAqB,CAA5C,EAA+C,CAAC,CAAhD,EAAmD,CAAC,CAApD,EAAuDJ,OAAvD,EAAgEC,QAAhE,EAA0EC,OAA1E;AACD,CAHD;;AAKAZ,SAASQ,SAAT,CAAmBO,sBAAnB,GAA4C,UAASL,OAAT,EAAkBC,QAAlB,EAA4BC,OAA5B,EAAqC;AAC/E,MAAI,KAAKP,QAAL,CAAcE,QAAlB,EAA4B;AAC5B,OAAKM,KAAL,CAAW,UAAX,EAAuB,CAAvB,EAA0B,KAAKX,MAAL,CAAYY,MAAtC,EAA8C,CAA9C,EAAiDJ,OAAjD,EAA0DC,QAA1D,EAAoEC,OAApE;AACD,CAHD;;AAKAZ,SAASQ,SAAT,CAAmBQ,KAAnB,GAA2B,UAASL,QAAT,EAAmBC,OAAnB,EAA4B;AACrD,OAAKP,QAAL,GAAgB,EAACC,UAAU,IAAX,EAAiBC,UAAU,IAA3B,EAAhB;;AAEA,MAAIU,SAAS,KAAKf,MAAL,CAAYC,GAAZ,CAAgB,UAASe,CAAT,EAAY;AAAE,WAAOA,EAAEF,KAAF,EAAP;AAAkB,GAAhD,CAAb;AACA,MAAIL,QAAJ,EACEZ,OAAOoB,GAAP,CAAWF,MAAX,EAAmBG,IAAnB,CAAwB,YAAW;AAAET,aAASU,IAAT,CAAcT,OAAd;AAAwB,GAA7D;AACH,CAND;;AAQAZ,SAASQ,SAAT,CAAmBK,KAAnB,GAA2B,UAASS,SAAT,EAAoBC,KAApB,EAA2BC,GAA3B,EAAgCC,IAAhC,EAAsCf,OAAtC,EAA+CC,QAA/C,EAAyDC,OAAzD,EAAkE;AAC3F,MAAIc,QAAQ,KAAKxB,MAAjB;AAAA,MACIyB,IAAQD,MAAMZ,MADlB;AAAA,MAEIc,OAAQ,IAFZ;;AAIA,SAAOD,GAAP;AAAYD,UAAMC,CAAN,EAASE,OAAT,CAAiBP,SAAjB;AAAZ,GAEA,IAAIQ,OAAO,SAAPA,IAAO,CAASC,KAAT,EAAgBC,KAAhB,EAAuBC,GAAvB,EAA4B;AACrC,QAAIF,UAAUP,GAAd,EAAmB,OAAOb,SAASU,IAAT,CAAcT,OAAd,EAAuBoB,KAAvB,EAA8BC,GAA9B,CAAP;;AAEnBP,UAAMK,KAAN,EAAaT,SAAb,EAAwBU,KAAxB,EAA+BC,GAA/B,EAAoC,UAASC,GAAT,EAAcC,CAAd,EAAiB;AACnD,UAAID,GAAJ,EAASN,KAAKvB,QAAL,CAAciB,SAAd,IAA2B,IAA3B;AACTQ,WAAKC,QAAQN,IAAb,EAAmBS,GAAnB,EAAwBC,CAAxB;AACD,KAHD;AAID,GAPD;AAQAL,OAAKP,KAAL,EAAY,IAAZ,EAAkBb,OAAlB;AACD,CAhBD;;AAkBA0B,OAAOC,OAAP,GAAiBrC,QAAjB","file":"index.js","sourcesContent":["'use strict';\n\nvar Cell   = require('./cell'),\n    Pledge = require('./pledge');\n\nvar Pipeline = function(sessions) {\n  this._cells   = sessions.map(function(session) { return new Cell(session) });\n  this._stopped = {incoming: false, outgoing: false};\n};\n\nPipeline.prototype.processIncomingMessage = function(message, callback, context) {\n  if (this._stopped.incoming) return;\n  this._loop('incoming', this._cells.length - 1, -1, -1, message, callback, context);\n};\n\nPipeline.prototype.processOutgoingMessage = function(message, callback, context) {\n  if (this._stopped.outgoing) return;\n  this._loop('outgoing', 0, this._cells.length, 1, message, callback, context);\n};\n\nPipeline.prototype.close = function(callback, context) {\n  this._stopped = {incoming: true, outgoing: true};\n\n  var closed = this._cells.map(function(a) { return a.close() });\n  if (callback)\n    Pledge.all(closed).then(function() { callback.call(context) });\n};\n\nPipeline.prototype._loop = function(direction, start, end, step, message, callback, context) {\n  var cells = this._cells,\n      n     = cells.length,\n      self  = this;\n\n  while (n--) cells[n].pending(direction);\n\n  var pipe = function(index, error, msg) {\n    if (index === end) return callback.call(context, error, msg);\n\n    cells[index][direction](error, msg, function(err, m) {\n      if (err) self._stopped[direction] = true;\n      pipe(index + step, err, m);\n    });\n  };\n  pipe(start, null, message);\n};\n\nmodule.exports = Pipeline;\n"]}